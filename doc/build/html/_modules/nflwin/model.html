<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>nflwin.model &mdash; NFLWin 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="NFLWin 0.1.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">NFLWin 0.1.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for nflwin.model</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Tools for creating and running the model.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.externals</span> <span class="kn">import</span> <span class="n">joblib</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.calibration</span> <span class="kn">import</span> <span class="n">CalibratedClassifierCV</span>
<span class="kn">from</span> <span class="nn">sklearn.cross_validation</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.grid_search</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">brier_score_loss</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KernelDensity</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.utils.validation</span> <span class="kn">import</span> <span class="n">NotFittedError</span>

<span class="kn">import</span> <span class="nn">preprocessing</span>
<span class="kn">import</span> <span class="nn">utilities</span>

<div class="viewcode-block" id="WPModel"><a class="viewcode-back" href="../../nflwin.html#nflwin.model.WPModel">[docs]</a><span class="k">class</span> <span class="nc">WPModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The object that computes win probabilities.</span>

<span class="sd">    In addition to holding the model itself, it defines some columns names likely to be</span>
<span class="sd">    used in the model as parameters to allow other users to more easily figure out which</span>
<span class="sd">    columns go into the model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    home_score_colname : string (default=&quot;curr_home_score&quot;)</span>
<span class="sd">        The name of the column containing the current home score at the start of a play.</span>
<span class="sd">    away_score_colname : string (default=&quot;curr_away_score&quot;)</span>
<span class="sd">        The name of the column containing the current away score at the start of a play.</span>
<span class="sd">    quarter_colname : string (default=&quot;quarter&quot;)</span>
<span class="sd">        The name of the column containing the quarter the play took place in.</span>
<span class="sd">    time_colname : string (default=&quot;seconds_elapsed&quot;)</span>
<span class="sd">        The name of the column containing the time elapsed (in seconds) from the start</span>
<span class="sd">        of the quarter when the play began.</span>
<span class="sd">    down_colname : string (default=&quot;down&quot;)</span>
<span class="sd">        The name of the column containing the current down number, with zeros for plays like</span>
<span class="sd">        kickoffs and extra points.</span>
<span class="sd">    yards_to_go_colname : string (default=&quot;yards_to_go&quot;)</span>
<span class="sd">        The name of the column containing the number of yards to go in order to get a first down.</span>
<span class="sd">    offense_team_colname : string (default=&quot;offense_team&quot;)</span>
<span class="sd">        The name of the column containing the abbreviation for the team currently on offense.</span>
<span class="sd">    home_team_colname : string (default=&quot;home_team&quot;)</span>
<span class="sd">        The name of the column containing the abbreviation for the home team.</span>
<span class="sd">    offense_won_colname : string (default=&quot;offense_won&quot;)</span>
<span class="sd">        The name of the column containing whether or not the offense ended up winning the game.</span>
<span class="sd">    copy_data : boolean (default=``True``)</span>
<span class="sd">        Whether or not to copy data when fitting and applying the model. Running the model</span>
<span class="sd">        in-place (``copy_data=False``) will be faster and have a smaller memory footprint,</span>
<span class="sd">        but if not done carefully can lead to data integrity issues.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : A Scikit-learn pipeline (or equivalent)</span>
<span class="sd">        The actual model used to compute WP. Upon initialization it will be set to</span>
<span class="sd">        a default model, but can be overridden by the user.</span>
<span class="sd">    training_seasons : A list of ints, or ``None`` (default=``None``)</span>
<span class="sd">        If the model was trained using data downloaded from nfldb, a list of the seasons</span>
<span class="sd">        used to train the model. If nfldb was **not** used, an empty list. If no model</span>
<span class="sd">        has been trained yet, ``None``.</span>
<span class="sd">    training_season_types : A list of strings or ``None`` (default=``None``)</span>
<span class="sd">        Same as ``training_seasons``, except for the portions of the seasons used in training the</span>
<span class="sd">        model (&quot;Preseason&quot;, &quot;Regular&quot;, and/or &quot;Postseason&quot;).</span>
<span class="sd">    validation_seasons : same as ``training_seasons``, but for validation data.</span>
<span class="sd">    validation_season_types : same as ``training_season_types``, but for validation data.</span>
<span class="sd">    sample_probabilities : A numpy array of floats or ``None`` (default=``None``)</span>
<span class="sd">        After the model has been validated, contains the sampled predicted probabilities used to</span>
<span class="sd">        compute the validation statistic.</span>
<span class="sd">    predicted_win_percents : A numpy array of floats or ``None`` (default=``None``)</span>
<span class="sd">        After the model has been validated, contains the actual probabilities in the test</span>
<span class="sd">        set at each probability in ``sample_probabilities``.</span>
<span class="sd">    num_plays_used : A numpy array of floats or ``None`` (default=``None``)</span>
<span class="sd">        After the model has been validated, contains the number of plays used to compute each</span>
<span class="sd">        element of ``predicted_win_percents``.</span>
<span class="sd">    model_directory : string</span>
<span class="sd">        The directory where all models will be saved to or loaded from.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span> <span class="s2">&quot;models&quot;</span><span class="p">)</span>
    <span class="n">_default_model_filename</span> <span class="o">=</span> <span class="s2">&quot;default_model.nflwin&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">home_score_colname</span><span class="o">=</span><span class="s2">&quot;curr_home_score&quot;</span><span class="p">,</span>
                 <span class="n">away_score_colname</span><span class="o">=</span><span class="s2">&quot;curr_away_score&quot;</span><span class="p">,</span>
                 <span class="n">quarter_colname</span><span class="o">=</span><span class="s2">&quot;quarter&quot;</span><span class="p">,</span>
                 <span class="n">time_colname</span> <span class="o">=</span> <span class="s2">&quot;seconds_elapsed&quot;</span><span class="p">,</span>
                 <span class="n">down_colname</span><span class="o">=</span><span class="s2">&quot;down&quot;</span><span class="p">,</span>
                 <span class="n">yards_to_go_colname</span><span class="o">=</span><span class="s2">&quot;yards_to_go&quot;</span><span class="p">,</span>
                 <span class="n">yardline_colname</span><span class="o">=</span><span class="s2">&quot;yardline&quot;</span><span class="p">,</span>
                 <span class="n">offense_team_colname</span><span class="o">=</span><span class="s2">&quot;offense_team&quot;</span><span class="p">,</span>
                 <span class="n">home_team_colname</span><span class="o">=</span><span class="s2">&quot;home_team&quot;</span><span class="p">,</span>
                 <span class="n">offense_won_colname</span><span class="o">=</span><span class="s2">&quot;offense_won&quot;</span><span class="p">,</span>
                 <span class="n">copy_data</span><span class="o">=</span><span class="bp">True</span>
                <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">home_score_colname</span> <span class="o">=</span> <span class="n">home_score_colname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">away_score_colname</span> <span class="o">=</span> <span class="n">away_score_colname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quarter_colname</span> <span class="o">=</span> <span class="n">quarter_colname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_colname</span> <span class="o">=</span> <span class="n">time_colname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">down_colname</span> <span class="o">=</span> <span class="n">down_colname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yards_to_go_colname</span> <span class="o">=</span> <span class="n">yards_to_go_colname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yardline_colname</span> <span class="o">=</span> <span class="n">yardline_colname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offense_team_colname</span> <span class="o">=</span> <span class="n">offense_team_colname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">home_team_colname</span> <span class="o">=</span> <span class="n">home_team_colname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offense_won_colname</span> <span class="o">=</span> <span class="n">offense_won_colname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_data</span> <span class="o">=</span> <span class="n">copy_data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_default_pipeline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_training_seasons</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_training_season_types</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validation_seasons</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validation_season_types</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sample_probabilities</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predicted_win_percents</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_plays_used</span> <span class="o">=</span> <span class="bp">None</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">training_seasons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_seasons</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">training_seasons_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_season_types</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">validation_seasons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_seasons</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">validation_seasons_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_season_types</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sample_probabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_probabilities</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">predicted_win_percents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predicted_win_percents</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_plays_used</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_plays_used</span>

<div class="viewcode-block" id="WPModel.train_model"><a class="viewcode-back" href="../../nflwin.html#nflwin.model.WPModel.train_model">[docs]</a>    <span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">source_data</span><span class="o">=</span><span class="s2">&quot;nfldb&quot;</span><span class="p">,</span>
                    <span class="n">training_seasons</span><span class="o">=</span><span class="p">[</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">2010</span><span class="p">,</span> <span class="mi">2011</span><span class="p">,</span> <span class="mi">2012</span><span class="p">,</span> <span class="mi">2013</span><span class="p">,</span> <span class="mi">2014</span><span class="p">],</span>
                    <span class="n">training_season_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Regular&quot;</span><span class="p">,</span> <span class="s2">&quot;Postseason&quot;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Train the model.</span>

<span class="sd">        Once a modeling pipeline is set up (either the default or something</span>
<span class="sd">        custom-generated), historical data needs to be fed into it in order to</span>
<span class="sd">        &quot;fit&quot; the model so that it can then be used to predict future results.</span>
<span class="sd">        This method implements a simple wrapper around the core Scikit-learn functionality</span>
<span class="sd">        which does this.</span>

<span class="sd">        The default is to use data from the nfldb database, however that can be changed</span>
<span class="sd">        to a simple Pandas DataFrame if desired (for instance if you wish to use data</span>
<span class="sd">        from another source).</span>

<span class="sd">        There is no particular output from this function, rather the parameters governing</span>
<span class="sd">        the fit of the model are saved inside the model object itself. If you want to get an</span>
<span class="sd">        estimate of the quality of the fit, use the ``validate_model`` method after running</span>
<span class="sd">        this method.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If you are loading in the default model, **there is no need to re-run this method**.</span>
<span class="sd">        In fact, doing so will likely result in weird errors and could corrupt the model if you</span>
<span class="sd">        were to try to save it back to disk.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source_data : the string ``&quot;nfldb&quot;`` or a Pandas DataFrame (default=``&quot;nfldb&quot;``)</span>
<span class="sd">            The data to be used to train the model. If ``&quot;nfldb&quot;``, will query the nfldb</span>
<span class="sd">            database for the training data (note that this requires a correctly configured</span>
<span class="sd">            installation of nfldb&#39;s database).</span>
<span class="sd">        training_seasons : list of ints (default=``[2009, 2010, 2011, 2012, 2013, 2014]``)</span>
<span class="sd">            What seasons to use to train the model if getting data from the nfldb database.</span>
<span class="sd">            If ``source_data`` is not ``&quot;nfldb&quot;``, this argument will be ignored.</span>
<span class="sd">            **NOTE:** it is critical not to use all possible data in order to train the</span>
<span class="sd">            model - some will need to be reserved for a final validation (see the</span>
<span class="sd">            ``validate_model`` method). A good dataset to reserve</span>
<span class="sd">            for validation is the most recent one or two NFL seasons.</span>
<span class="sd">        training_season_types : list of strings (default=``[&quot;Regular&quot;, &quot;Postseason&quot;]``)</span>
<span class="sd">            If querying from the nfldb database, what parts of the seasons to use.</span>
<span class="sd">            Options are &quot;Preseason&quot;, &quot;Regular&quot;, and &quot;Postseason&quot;. If ``source_data`` is not</span>
<span class="sd">            ``&quot;nfldb&quot;``, this argument will be ignored.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ``None``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_training_seasons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_training_season_types</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">source_data</span> <span class="o">==</span> <span class="s2">&quot;nfldb&quot;</span><span class="p">:</span>
            <span class="n">source_data</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">get_nfldb_play_data</span><span class="p">(</span><span class="n">season_years</span><span class="o">=</span><span class="n">training_seasons</span><span class="p">,</span>
                                                        <span class="n">season_types</span><span class="o">=</span><span class="n">training_season_types</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_training_seasons</span> <span class="o">=</span> <span class="n">training_seasons</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_training_season_types</span> <span class="o">=</span> <span class="n">training_season_types</span>
        <span class="n">target_col</span> <span class="o">=</span> <span class="n">source_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">offense_won_colname</span><span class="p">]</span>
        <span class="n">feature_cols</span> <span class="o">=</span> <span class="n">source_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offense_won_colname</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">,</span> <span class="n">target_col</span><span class="p">)</span></div>

<div class="viewcode-block" id="WPModel.validate_model"><a class="viewcode-back" href="../../nflwin.html#nflwin.model.WPModel.validate_model">[docs]</a>    <span class="k">def</span> <span class="nf">validate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">source_data</span><span class="o">=</span><span class="s2">&quot;nfldb&quot;</span><span class="p">,</span>
                       <span class="n">validation_seasons</span><span class="o">=</span><span class="p">[</span><span class="mi">2015</span><span class="p">],</span>
                       <span class="n">validation_season_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Regular&quot;</span><span class="p">,</span> <span class="s2">&quot;Postseason&quot;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Validate the model.</span>

<span class="sd">        Once a modeling pipeline is trained, a different dataset must be fed into the trained model</span>
<span class="sd">        to validate the quality of the fit.</span>
<span class="sd">        This method implements a simple wrapper around the core Scikit-learn functionality</span>
<span class="sd">        which does this.</span>

<span class="sd">        The default is to use data from the nfldb database, however that can be changed</span>
<span class="sd">        to a simple Pandas DataFrame if desired (for instance if you wish to use data</span>
<span class="sd">        from another source).</span>

<span class="sd">        The output of this method is a p value which represents the confidence at which</span>
<span class="sd">        we can reject the null hypothesis that the model predicts the appropriate win</span>
<span class="sd">        probabilities. This number is computed by first smoothing the predicted win probabilities of both all test data and</span>
<span class="sd">        just the data where the offense won with a gaussian `kernel density</span>
<span class="sd">        estimate &lt;http://scikit-learn.org/stable/modules/generated/sklearn.neighbors.KernelDensity.html#sklearn.neighbors.KernelDensity&gt;`_</span>
<span class="sd">        with standard deviation = 0.01. Once the data is smooth, ratios at each percentage point from 1% to 99% are computed (i.e.</span>
<span class="sd">        what fraction of the time did the offense win when the model says they have a 1% chance of winning, 2% chance, etc.). Each of</span>
<span class="sd">        these ratios should be well approximated by the binomial distribution, since they are essentially independent (not perfectly</span>
<span class="sd">        but hopefully close enough) weighted coin flips, giving a p value. From there `Fisher&#39;s method &lt;https://en.wikipedia.org/wiki/Fisher%27s_method&gt;`_</span>
<span class="sd">        is used to combine the p values into a global p value. A p value close to zero means that the model is unlikely to be</span>
<span class="sd">        properly predicting the correct win probabilities. A p value close to one, **while not proof that the model is correct**,</span>
<span class="sd">        means that the model is at least not inconsistent with the hypothesis that it predicts good win probabilities.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source_data : the string ``&quot;nfldb&quot;`` or a Pandas DataFrame (default=``&quot;nfldb&quot;``)</span>
<span class="sd">            The data to be used to train the model. If ``&quot;nfldb&quot;``, will query the nfldb</span>
<span class="sd">            database for the training data (note that this requires a correctly configured</span>
<span class="sd">            installation of nfldb&#39;s database).</span>
<span class="sd">        training_seasons : list of ints (default=``[2015]``)</span>
<span class="sd">            What seasons to use to validate the model if getting data from the nfldb database.</span>
<span class="sd">            If ``source_data`` is not ``&quot;nfldb&quot;``, this argument will be ignored.</span>
<span class="sd">            **NOTE:** it is critical not to use the same data to validate the model as was used</span>
<span class="sd">            in the fit. Generally a good data set to use for validation is one from a time</span>
<span class="sd">            period more recent than was used to train the model. For instance, if the model was trained</span>
<span class="sd">            on data from 2009-2014, data from the 2015 season would be a sensible choice to validate the model.</span>
<span class="sd">        training_season_types : list of strings (default=``[&quot;Regular&quot;, &quot;Postseason&quot;]``)</span>
<span class="sd">            If querying from the nfldb database, what parts of the seasons to use.</span>
<span class="sd">            Options are &quot;Preseason&quot;, &quot;Regular&quot;, and &quot;Postseason&quot;. If ``source_data`` is not</span>
<span class="sd">            ``&quot;nfldb&quot;``, this argument will be ignored.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float, between 0 and 1</span>
<span class="sd">            The combined p value, where smaller values indicate that the model is not accurately predicting win</span>
<span class="sd">            probabilities.</span>
<span class="sd">            </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotFittedError</span>
<span class="sd">            If the model hasn&#39;t been fit.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Probabilities are computed between 1 and 99 percent because a single incorrect prediction at 100% or 0% automatically drives</span>
<span class="sd">        the global p value to zero. Since the model is being smoothed this situation can occur even when there are no model predictions</span>
<span class="sd">        at those extreme values, and therefore leads to erroneous p values.</span>

<span class="sd">        While it seems reasonable (to me at least), I am not totally certain that this approach is entirely correct.</span>
<span class="sd">        It&#39;s certainly sub-optimal in that you would ideally reject the null hypothesis that the model predictions</span>
<span class="sd">        **aren&#39;t** appropriate, but that seems to be a much harder problem (and one that would need much more test</span>
<span class="sd">        data to beat down the uncertainties involved). I&#39;m also not sure if using Fisher&#39;s method is appropriate here,</span>
<span class="sd">        and I wonder if it might be necessary to Monte Carlo this. I would welcome input from others on better ways to do this.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_seasons</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFittedError</span><span class="p">(</span><span class="s2">&quot;Must fit model before validating.&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_validation_seasons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validation_season_types</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">source_data</span> <span class="o">==</span> <span class="s2">&quot;nfldb&quot;</span><span class="p">:</span>
            <span class="n">source_data</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">get_nfldb_play_data</span><span class="p">(</span><span class="n">season_years</span><span class="o">=</span><span class="n">validation_seasons</span><span class="p">,</span>
                                                        <span class="n">season_types</span><span class="o">=</span><span class="n">validation_season_types</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validation_seasons</span> <span class="o">=</span> <span class="n">validation_seasons</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validation_season_types</span> <span class="o">=</span> <span class="n">validation_season_types</span>
            
        <span class="n">target_col</span> <span class="o">=</span> <span class="n">source_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">offense_won_colname</span><span class="p">]</span>
        <span class="n">feature_cols</span> <span class="o">=</span> <span class="n">source_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offense_won_colname</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">predicted_probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sample_probabilities</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predicted_win_percents</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_plays_used</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">WPModel</span><span class="o">.</span><span class="n">_compute_predicted_percentages</span><span class="p">(</span><span class="n">target_col</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">predicted_probabilities</span><span class="p">))</span>

        <span class="c1">#Compute p-values for each where null hypothesis is that distributions are same, then combine</span>
        <span class="c1">#them all to make sure data is not inconsistent with accurate predictions.</span>
        <span class="n">combined_pvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_distribution</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_probabilities</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">predicted_win_percents</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">num_plays_used</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">combined_pvalue</span></div>

<div class="viewcode-block" id="WPModel.predict_wp"><a class="viewcode-back" href="../../nflwin.html#nflwin.model.WPModel.predict_wp">[docs]</a>    <span class="k">def</span> <span class="nf">predict_wp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plays</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimate the win probability for a set of plays.</span>

<span class="sd">        Basically a simple wrapper around ``WPModel.model.predict_proba``,</span>
<span class="sd">        takes in a DataFrame and then spits out an array of predicted</span>
<span class="sd">        win probabilities.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        plays : Pandas DataFrame</span>
<span class="sd">            The input data to use to make the predictions.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Numpy array, of length ``len(plays)``</span>
<span class="sd">            Predicted probability that the offensive team in each play</span>
<span class="sd">            will go on to win the game.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotFittedError</span>
<span class="sd">            If the model hasn&#39;t been fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_seasons</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFittedError</span><span class="p">(</span><span class="s2">&quot;Must fit model before predicting WP.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">plays</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="WPModel.plot_validation"><a class="viewcode-back" href="../../nflwin.html#nflwin.model.WPModel.plot_validation">[docs]</a>    <span class="k">def</span> <span class="nf">plot_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the validation data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        axis : matplotlib.pyplot.axis object or ``None`` (default=``None``)</span>
<span class="sd">            If provided, the validation line will be overlaid on ``axis``.</span>
<span class="sd">            Otherwise, a new figure and axis will be generated and plotted on.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Arguments to ``axis.plot``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        matplotlib.pylot.axis</span>
<span class="sd">            The axis the plot was made on.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotFittedError</span>
<span class="sd">            If the model hasn&#39;t been fit **and** validated.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_probabilities</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFittedError</span><span class="p">(</span><span class="s2">&quot;Must validate model before plotting.&quot;</span><span class="p">)</span>
        
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Predicted WP&quot;</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Actual WP&quot;</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_probabilities</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">predicted_win_percents</span><span class="p">,</span>
                  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">axis</span></div>
            

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_test_distribution</span><span class="p">(</span><span class="n">sample_probabilities</span><span class="p">,</span> <span class="n">predicted_win_percents</span><span class="p">,</span> <span class="n">num_plays_used</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Based off assuming the data at each probability is a Bernoulli distribution.&quot;&quot;&quot;</span>

        <span class="c1">#Get the p-values:</span>
        <span class="n">p_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">stats</span><span class="o">.</span><span class="n">binom_test</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">predicted_win_percents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_plays_used</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                                     <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">num_plays_used</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                                     <span class="n">p</span><span class="o">=</span><span class="n">sample_probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_probabilities</span><span class="p">))]</span>
        <span class="n">combined_p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">combine_pvalues</span><span class="p">(</span><span class="n">p_values</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">combined_p_value</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_compute_predicted_percentages</span><span class="p">(</span><span class="n">actual_results</span><span class="p">,</span> <span class="n">predicted_win_probabilities</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the sample percentages from a validation data set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kde_offense_won</span> <span class="o">=</span> <span class="n">KernelDensity</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">bandwidth</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="p">(</span><span class="n">predicted_win_probabilities</span><span class="p">[(</span><span class="n">actual_results</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)])[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
        <span class="n">kde_total</span> <span class="o">=</span> <span class="n">KernelDensity</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">bandwidth</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">predicted_win_probabilities</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
        <span class="n">sample_probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>
        <span class="n">number_density_offense_won</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">kde_offense_won</span><span class="o">.</span><span class="n">score_samples</span><span class="p">(</span><span class="n">sample_probabilities</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">actual_results</span><span class="p">))</span>
        <span class="n">number_density_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">kde_total</span><span class="o">.</span><span class="n">score_samples</span><span class="p">(</span><span class="n">sample_probabilities</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual_results</span><span class="p">)</span>
        <span class="n">number_offense_won</span> <span class="o">=</span> <span class="n">number_density_offense_won</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">actual_results</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number_density_offense_won</span><span class="p">)</span>
        <span class="n">number_total</span> <span class="o">=</span> <span class="n">number_density_total</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual_results</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number_density_total</span><span class="p">)</span>
        <span class="n">predicted_win_percents</span> <span class="o">=</span> <span class="n">number_offense_won</span> <span class="o">/</span> <span class="n">number_total</span>

        <span class="k">return</span> <span class="n">sample_probabilities</span><span class="p">,</span> <span class="n">predicted_win_percents</span><span class="p">,</span> <span class="n">number_total</span>
    
<div class="viewcode-block" id="WPModel.create_default_pipeline"><a class="viewcode-back" href="../../nflwin.html#nflwin.model.WPModel.create_default_pipeline">[docs]</a>    <span class="k">def</span> <span class="nf">create_default_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the default win probability estimation pipeline.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Scikit-learn pipeline</span>
<span class="sd">            The default pipeline, suitable for computing win probabilities</span>
<span class="sd">            but by no means the best possible model.</span>

<span class="sd">        This can be run any time a new default pipeline is required,</span>
<span class="sd">        and either set to the ``model`` attribute or used independently.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">is_offense_home</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">ComputeIfOffenseIsHome</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offense_team_colname</span><span class="p">,</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">home_team_colname</span><span class="p">,</span>
                                                               <span class="n">copy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy_data</span><span class="p">)</span>
        <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;compute_offense_home&quot;</span><span class="p">,</span> <span class="n">is_offense_home</span><span class="p">))</span>
        <span class="n">score_differential</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">CreateScoreDifferential</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home_score_colname</span><span class="p">,</span>
                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">away_score_colname</span><span class="p">,</span>
                                                                   <span class="n">is_offense_home</span><span class="o">.</span><span class="n">offense_home_team_colname</span><span class="p">,</span>
                                                                   <span class="n">copy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy_data</span><span class="p">)</span>
        <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;create_score_differential&quot;</span><span class="p">,</span> <span class="n">score_differential</span><span class="p">))</span>
        <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;map_downs_to_int&quot;</span><span class="p">,</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">MapToInt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">down_colname</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy_data</span><span class="p">)))</span>
        <span class="n">total_time_elapsed</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">ComputeElapsedTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quarter_colname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_colname</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy_data</span><span class="p">)</span>
        <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;compute_total_time_elapsed&quot;</span><span class="p">,</span> <span class="n">total_time_elapsed</span><span class="p">))</span>
        <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;remove_unnecessary_columns&quot;</span><span class="p">,</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">CheckColumnNames</span><span class="p">(</span>
            <span class="n">column_names</span><span class="o">=</span><span class="p">[</span><span class="n">is_offense_home</span><span class="o">.</span><span class="n">offense_home_team_colname</span><span class="p">,</span>
                          <span class="n">score_differential</span><span class="o">.</span><span class="n">score_differential_colname</span><span class="p">,</span>
                          <span class="n">total_time_elapsed</span><span class="o">.</span><span class="n">total_time_colname</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">yardline_colname</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">yards_to_go_colname</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">down_colname</span><span class="p">],</span>
            <span class="n">copy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy_data</span><span class="p">)))</span>
        <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;encode_categorical_columns&quot;</span><span class="p">,</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">OneHotEncoderFromDataFrame</span><span class="p">(</span>
            <span class="n">categorical_feature_names</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">down_colname</span><span class="p">],</span>
            <span class="n">copy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy_data</span><span class="p">)))</span>

        <span class="n">search_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;base_estimator__penalty&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="s1">&#39;l2&#39;</span><span class="p">],</span>
                       <span class="s1">&#39;base_estimator__C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
                      <span class="p">}</span>
        <span class="n">base_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
        <span class="n">calibrated_model</span> <span class="o">=</span> <span class="n">CalibratedClassifierCV</span><span class="p">(</span><span class="n">base_model</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;isotonic&quot;</span><span class="p">)</span>
        <span class="n">grid_search_model</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">calibrated_model</span><span class="p">,</span> <span class="n">search_grid</span><span class="p">,</span>
                             <span class="n">scoring</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_brier_loss_scorer</span><span class="p">)</span>
        <span class="c1">#steps.append((&quot;compute_model&quot;, grid_search_model))</span>
        <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;compute_model&quot;</span><span class="p">,</span> <span class="n">calibrated_model</span><span class="p">))</span>

        <span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pipe</span></div>

<div class="viewcode-block" id="WPModel.save_model"><a class="viewcode-back" href="../../nflwin.html#nflwin.model.WPModel.save_model">[docs]</a>    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the WPModel instance to disk.</span>

<span class="sd">        All models are saved to the same place, with the installed</span>
<span class="sd">        NFLWin library (given by ``WPModel.model_directory``). </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : string (default=None):</span>
<span class="sd">            The filename to use for the saved model. If this parameter</span>
<span class="sd">            is not specified, save to the default filename. Note that if a model</span>
<span class="sd">            already lists with this filename, it will be overwritten. Note also that</span>
<span class="sd">            this is a filename only, **not** a full path. If a full path is specified</span>
<span class="sd">            it is likely (albeit not guaranteed) to cause errors.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ``None``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_model_filename</span>
        <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="WPModel.load_model"><a class="viewcode-back" href="../../nflwin.html#nflwin.model.WPModel.load_model">[docs]</a>    <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load a saved WPModel.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Same as ``save_model``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ``nflwin.WPModel`` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_default_model_filename</span>
            
        <span class="k">return</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">model_directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_brier_loss_scorer</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use the Brier loss to estimate model score.</span>

<span class="sd">        For use in GridSearchCV, instead of accuracy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">predicted_positive_probabilities</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">brier_score_loss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">predicted_positive_probabilities</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">NFLWin 0.1.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Andrew Schechtman-Rook.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>